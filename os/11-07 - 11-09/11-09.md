# 교착 상태



## 교착 상태 (Dead Lock)

- 교착상태의 개요
- 교착상태 필요조건
- 교착상태 해결방법
- 다중 자언과 교착 상태 검출



### 교착 상태의 정의

---

- 2개 이상의 프로세스가 다른 프로세스의 작업을 기다리며 더이상 일의 진행을 못하는 상태 (무한 대기)
- 아사 상태와 차이점
    - 아사 현상 : 운영체제가 잘못된 정책을 사용하여 특정 프로세스의 작업이 지연되는 문제
    - 교착 상태 : 여러 프로세스가 작업을 진행하다보니 자연적으로 일어나는 문제
        - 운영체제의 문제는 아니다, 아사 현상과 다르게 해결하는게 어렵다



### 자원할당 그래프

![image](img\image.png)

- 프로세스가 어떤 자원을 사용중이고 어떤 자원을 기다리고 있는지를 방향성 있는 그래프로 나타낸 것
- 프로세스는 원, 자원은 사각형으로 표현



### 교착 상태 필요 조건

- 상호 배제 : 한 프로세스가 사용하는 자원은 다른 프로세스와 공유 할 수 없는 자원이여야 함
- 비선점 : 한 프로세스가 사용 중인 자원은 중간에 다른 프로세스가 가져갈 수 없어야함
- 점유와 대기 : 프로세스가 어떤 자원을 할당받은 상태에서 다른 자원을 기다리는 상태여야 함
- 원형 대기 : 점유와 대기를 하는 프로세스 간의 과녜가 원을 이루어야 함

- 식사하는 철학자 문제
    - 왼쪽에 있는 포크를 잡은뒤 오른쪽에 있는 포크를 잡아야만 식사가 가능
    
    → 자원을 공유하지 못하면 교착상태가 됨
    
    → 자원을 뺏을 수 없으면 내려놓을 때 까지 기다려야하므로 교착 상태가 됨
    
    → 자원 하나를 집은 상태에서 다른 자원을 기다리면 교착 상태가 발생
    
    → 자원을 요구하는 방향이 원형을 이루면 영보를 하지 못하므로 교착 상태가 발생한다
    
- 만일 사각형 테이블 구조인경우
    - 교착상태는 발생하지 않지만, 한쪽 끝에서 부터 철학자가 식사를 끝마치고 다음으로 넘어가는 걸 기다리는 아사 현상이 있을 수 있음
    
- 교착상태 해결 방법
  
  
    | 해결방법 | 특징 |
    | --- | --- |
    | 교착 상태 예방 | 교착 상태를 유발하는 네 가지 조건을 무력화한다 |
    | 교착 상태 회피 | 교착 상태가 발생하지 않는 수준으로 자원을 할당한다 |
    | 교착 상태 검출 | 자원 할당 그래프를 사용하여 교착 상태를 발견한다 |
    | 교착 상태 회복 | 교착 상태를 검출한 후 해결한다 |
    - 예방, 회피, 검출이 대표적이고 발견후에 회복하는 방법이 있다.
    - 교착 상태 **예방**
        - 교착 상태를 유발하는 네 가지 조건이 발생하지 않도록 무력화하는 방식
    - 교착 상태 **회피**
        - 자원 할당량을 조절하여 교착 상태를 해결하는 방식
    - 교착 상태 **검출과 회복**
        - 교착 상태 검출은 어떤 제약을 가하지 않고 자원 할당 그래프를 모니ㅓ링하면서 교착 상태가 발생하는지 살펴보는 방식, 발생한경우 교착 상태 회복 단계를 실시
    



### 상호 배제 예방

- 독점적으로 사용할 수 있는 자원을 없애는 방법
- 시스템 내의 모든 자원을 공유하는 방식
- 현실적으로 불가능한 방법



### 비선점 예방

- 모든 자원을 빼앗는 방법
- 마찬가지로 임계구역의 잠금 기능을 사용하면 사용할 수 없고, 상호 배제를 보장할 수 없기 때문에 불가능한 방법



### 점유와 대기 예방

- 프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법
- 선착순 점유순으로 작동하되, 대기하지 않는 구조
- 당장 사용하지 않는 미래의 자원도 미리 선점하여 작동하는 방식

- **단점**
    - 프로세스가 자신이 사용하는 모든 단점을 자세히 알기 어려움
    - 자원의 활용성이 떨어짐
    - 많은 자원을 사용하는 프로세스가 적은 프로세스보다 불리함
    - 결과적으로 일괄 작업으로 동작
    



### 원형 대기 예방

- 점유와 대기를 하는 프로세스들이 원형을 이루지 못하도록 하는 방식
- 모든 자원에 숫자를 부여하고, 숫자가 큰 방향으로만 자원을 할당 하는 것
- 단점
    - 프로세스 작업 진행에 유연성이 떨어짐 
    → (마우스1, 하드2, 프린터 3 일때) → 마우스 사용후 프린터는 가능하지만 그 반대는 불가능
    - 자원의 번호를 부여하는데 판단이 어려움



### 교착 상태 회피의 개념

- 프로세스에 자원을 할당할 때 어느 수준 이상의 자원을 나누어 주면 교착 상태가 발생하는지 파악하여 그 수준 이하로 자원을 나누는 방법
- 교착<img src="img\스크린샷_2022-04-18_오후_4.25.29.png" alt="스크린샷_2022-04-18_오후_4.25.29" style="zoom:50%;" />상태가 발생하지 않는 범위에서만 자원을 할당하고 그외에 경우엔 대기를 시키는 방법

- 안정 상태와 불안정 상태
    - 할당된 자원수와 자원의 총수를 기준으로 안정 상태, 불안정 상태를 결정하고 안정상태를 유지하도록 자원을 할당
    - 할당 자원이 작을수록 안정 상태가 크고, 늘어날수록 불안정 상태가 커짐
    - 교착상태는 불안정상태의 일부분이며 불안저 상태가 커질수록 교착상태가 발생할 확률이 큼
    



### 은행원 알고리즘(bank algorithm)

- 교착 상태를 회피하는 대표적 알고리즘
- 은행이 대출 해주는 방식, 즉 대출 가능한 범위 내이면 허용되지만 그렇지 않으면 거부되는 것과 비슷한 방식

- 변수
  
  
    | 변수 | 설명 |
    | --- | --- |
    | 전체 자원(Total) | 시스템 내 전체 자원 수 |
    | 가용 자원(Available) | 시스템 내 현재 사용할 수 있는 자원의 수(= 전체자원 - 모든 프로세스 할당 자원) |
    | 촤대 저원(Max) | 각 프로세스가 선언한 최대 자원의 수 |
    | 할당 자원(Alloctation) | 각 프로세스에 현재 할당된 자원의 수 |
    | 기대 자원(Expect) | 각 프로세스가 앞으로 사용할 자원의 수(= 최대자원 - 할당자원) |
- 할당 기준
    - 각 프로세스의 기대 자원가 비교하여 **가용 자원이 하나라도 크거나** 같으면 자원을 할당
    - 가용 자원이 어던 기대 자원보다 크지 않으면 할당 안함
      
        <img src="img\스크린샷_2022-04-18_오후_4.37.13.png" alt="스크린샷_2022-04-18_오후_4.37.13" style="zoom:33%;" />
    
    <img src="img\스크린샷_2022-04-18_오후_4.37.31.png" alt="스크린샷_2022-04-18_오후_4.37.31" style="zoom:33%;" />

<aside>
💡 안전상태 : 각 프로세스의 기대자원과 비교하여 가용 자원이 크거나 같은 경우가 한 번 이상인 경우

- 교착 상태 회피의 문제점
    - 프로세스가 자신이 사용할 모든 자원을 미리 선언해야 함
    - 시스템 전체 자원 수가 고정적여이여 함
    - 자원이 낭비됨
    



## 교착상태 검출

- **타임아웃 이용**
- **자원할당그래프 이용**



### 교착상태 검출의 개념

- 운영체제가 프로세스의 작업을 관찰하면서 교착 상태의 여부를 주시하는 방식
- 발견되면 이후 회복 단계를 밟음

- **타임아웃을 이용한 교착 상태 검출**
    - 일정 시간 동안 작업이 진행되지 않는 프로세스를 교착 상태가 발생한 것으로 간주하여 처리하는 방법
    - 교착 상태가 자주 발생하지 않는 것을 가저으로 하기에 사용하는 것, 특별한 알고리즘이 없어, 쉽계 구현가능
    - 타임아웃 발생시 프로세스 종료
    - 문제점
        - 데이터베이스에서 타임아웃으로 종료되면 일부 데이터의 일관성이 깨질 수 있음
        - 일관성 깨짐 방지를 위해 체크포인트와 롤백 사용
            - 체크포인트 : 작업문제 이전 상태로 돌아가기 위한 표시
            - 롤백 : 작업을 체크포인트 상태로 되돌아가는 것

- **자원할당그래프를 이용한 교착상태 검출**
    - 단일 자원을 사용하는 경우 자원 할당 그래프에 사이클 있으면 교착 상태
      
        <img src="img\스크린샷_2022-04-18_오후_5.03.10.png" alt="스크린샷_2022-04-18_오후_5.03.10" style="zoom:33%;" />



### 교착 상태 회복

---

- 교착 상태가 검출된 후 교착 상태를 푸는 후속 작업을 하는 것
- 교착 상태 회복 단계에서는 교착 상태를 유발한 프로세스를 강제로 종료
→ 이후의 순차적으로 다시 실행

- 프로세스를 강제 종료하는 방법
    1. 교착 상태를 일으킨 모든 프로세스를 동시에 종료
    2. 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료
        1. 우선순위가 낮은 프로세스를 먼저 종료
        2. 우선순위가 같은 경우, 작업 시간이 짧은 프로세스를 먼저 종료
        3. 위의 두 조건이 같은 경우 자원을 많이 사용하는 프로세스를 먼저 종료 한다



## 다중 자원과 교착 상태 검출



### 다중 자원과 사이클

- 다중 자원이 포함된 자원 할당 그래프에서는 대기 그래프와 그래프 감소 방법을 이용하여 사이클을 찾음



### 대기 그래프

- 자원할당 그래프에서 프로세스와 프로세스 간에 기다리는 관계만 나타낸 그래프



### 그래프 감소

- 그래프에서 작업이 끝날 가능성이 있는 프로세스의 화살표와 관련 프로세스의 화살표를 연속적으로 지워가는 작업을 말한다.
  → 다중 자원이 있는 대기 그래프에서 그래프 감소를 완료한 대기 그래프에도 사이클이 남아 있다면 교착 상태가 발생한 것으로 판단한다.
  
    <img src="img\스크린샷_2022-04-18_오후_5.14.29.png" alt="스크린샷_2022-04-18_오후_5.14.29" style="zoom:33%;" />
  
    1. 작업이 끝날 수 있는 프로세스, 즉 기다리는 자원이 없는 프로세스 P2에 대해 P1에서 P2로 가는 화살표를 지운다.
    2. P1이 작업을 종료할 수 있으므로 P4에서 P1으로 가는 화살표를 지운다.
    3. P4가 작업을 종료할 수 있으므로 P3에서 P4로 가는 화살표를 지운다.
    4. P3이 작업을 종료할 수 있으므로 P1에서 P3로 가는 화살표를 지운다.
        - 그래프 감소 결과 사이클이 남아 있지 않으므로 교착 상태가 발생 하지 않음
  
    <img src="img\스크린샷_2022-04-18_오후_5.14.56.png" alt="스크린샷_2022-04-18_오후_5.14.56" style="zoom:33%;" />
  
    - 그래프 감소 결과 사이클이 남아 있으므로 교착상태 발생
  
      

<aside>
💡 결론 : 교착상태에 대한 예방은 실질적으론 불가능 하다. 이를 위해 자원 할당량을 조절하고 유발 가능성이 있는 프로세스에게 자원 할당을 회피 하는 방법을 사용하고, 이마저도 실패의 교착상태가 발생한 경우 검출과 회복단계를 통해 모니터링 하여, 교착상태를 확인하고 회복단계 과정을 거쳐 회복을 진행한다. 여기서 회복은 간단하게 동시에, 혹은 조건에따라 순차적으로 껏다 키는 방식으로 작동한다