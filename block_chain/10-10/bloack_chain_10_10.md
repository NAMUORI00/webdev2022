# 이더리움 플랫폼의 작동원리



### 이더리움 작동과정

- 이더리움은 정확히 프로그래밍한 대로 작동하는 스마트 컨트랙트를 작동시키는 분산된 플랫폼 이다
  
    ![스크린샷 2022-05-02 오전 11.11.36.png](10-10/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-02_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.11.36.png)
    

### 이더리움과 계정 - 이더리움의 블록 구조

- 제로 지식 증명



### 이더리움 트리 구조

- Trie : 문자열을 저장하고 효율적으로 탐색하기 위한 트리 형태의 자료구조
    - **자동완성 기능, 사전 검색 등 문자열을 탐색하는데 특화 되어있는 자료구조**
    - 래딕스 트리(radix tree) or 접두사 트리 (prefix tree) or 탐색 트리(rtrieval tree)라고도 한다. 트라이는 retrieval tree에서 나온 단어



### 이더리움 트리 구조 - 확장 머클 패트리샤 트리

- **레딕스 트리를 최적화 하기 위해 세 가지 서로 다른 노드를 정의**
    - 브렌치 노드(branch node)
        - 16개의 16진수 값과 value를 갖고 있다
        - 이 노드를 통해 가지치기가 시작됨
    - 확장 노드(extension node)
        - 공유되어질 키값들을 저장
        - 노드 자체로는 종격되지 않기 때문에, value를 통해 이후의 키 값을 책임질 브랜치 노드를 갖게됨
    - 잎 노드(leaf node)
        - 키값에 대한 패스가 종결되었을 때 value 에 해당 주소에 대한 정보들을 포함

- 실제로 어떤 경로를 통해 각각 데이터가 저장되는가
    - stateRoot
    - transactionRoot
    - receiptsRoot



### 이더리움 해시 퍼즐

![스크린샷 2022-05-12 오전 10.13.50.png](10-10/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-12_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_10.13.50.png)

- SHA256 → SHA-3
- 메모리 하드 방식
    - 느린 메모리 접근 속도로 극대화된 연산속도 효과 상쇄
    - 가격 대비 성능 제한으로 ASIC을 통한 대량 병렬화의 효율 감소 → 진입장벽 낮춤
        - ASIC : 특정목적에 전문화한 반도체
        - [http://wiki.hash.kr/index.php/에이식](http://wiki.hash.kr/index.php/%EC%97%90%EC%9D%B4%EC%8B%9D)



### 이더리움 해시 퍼즐의 계산

![https://www.researchgate.net/profile/Omar-Cheikhrouhou/publication/350601431/figure/fig2/AS:1035998221844480@1624012632431/Flow-diagram-of-the-Ethash-algorithm-used-by-Ethereum-with-a-DAG-size-of-237-GB-of-late.png](https://www.researchgate.net/profile/Omar-Cheikhrouhou/publication/350601431/figure/fig2/AS:1035998221844480@1624012632431/Flow-diagram-of-the-Ethash-algorithm-used-by-Ethereum-with-a-DAG-size-of-237-GB-of-late.png)

> 기존 비트코인 블록체인과 달리 dag 페이지 탐색등의 몇가지 중간단계가 추가됨
> 
- 단순한 비트코인의 난스값 증가를 통한 반복적 해시 함수 계산이 아닌 방식을 채용
    - 이더리움 해시퍼즐에선 계산을 위해 매번 64회의 걸쳐 데이터셋(DAG)에서 반복적으로 읽어온 후 이를 이용해 계산해야 하는 방식을 채용
    → 이 과정을 위해 메모리에 있는 데이터셋에서 특정값을 반복적으로 읽어오는데 이 방식으로 인해 전체 연산 속도에 의도적인 제약을 걸어 ASIC화를 예방하고 기존보다 진입장벽을 낮출수 있게 되었다

> 다만 아이러니 하게도 이러한 방식을 채택한 이더리움 역시 상위 몇 채굴집단이 형성되어 약 65%의 점유를 가지고 있는 상황이다
> 



### 이더리움 해시퍼즐 난이도 조절 (이더리움 합의엔진 Ethash)

- 비트코인과 마찬가지로 난이도 조절을한다
- 비트코인은 2016개의 블록이 생성될 때마다 난이도를 조절하지만 이더리움은 매번 새 블록이 생성될때 마다 난이도를 조절한다
→ 이는 약 비트코인에 비해 80640배 더 많이 난이도 조절을 하는 셈이다
- 난이도는 생성 속도를 약 15초에 맞추는것을 목표로 조절한다

$$
블록의 난이도 = 부모블록의난이도 + 난이도동적조절+10만개블록마다난이도조정
$$

→ 여기서 난이도 동적 조절은 쉽게 요약하자면 부모 블록의 난이도로부터 최대 1/2048만큼 상향되거나 99/2048 만큼 하향 조절한다는 것이다.

- DAG
    - geth 클라이언트에서 마이닝을 구동시키면 즉시 디스크 IO가 발생하며, 십수분 후에는 홈 디렉터리의 디스크 사용량이 2G 가량 증가하는 것을 경험하게 된다. 이는 Ethash에서 캐시 영역을 확보하기 위해 시드 해시를 생성하는 것이다. 시드해시로 생성된 약 2G 정도의 캐시 데이터 집합을 **DAG 파일**이라 한다.
    - 현재는 30,000 블록 주기로 DAG 파일을 재생성하게 되어 있는데, 이 30,000 블록 단위의 주기를 **에포크** 라고 한다
    
- 넌스와 믹스해시
  
    ![스크린샷 2022-05-12 오전 11.07.46.png](10-10/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-12_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.07.46.png)
    
    - 믹스해시는 작업 증명 계산을 할떄 넌스를 이용하여 생성된 중간단계의 128바이트 해시값이다
    
    ![스크린샷 2022-05-12 오전 11.07.34.png](10-10/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-12_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.07.34.png)
    
    ![스크린샷 2022-05-12 오전 11.08.24.png](10-10/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-12_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.08.24.png)
    
- 난이도와 타임스탬프
    - 블록 생성을 위한 목표 난이도를 도출하기 위해서는 현재 시각의 타임스탬프가 필요하다.
    - 현재 타임스탬프는 모든 블록의 블록 헤더에 포함되어 블록의 유효성을 검사하는 데 사용된다
    → 난이도 조절에 타임스탬프 값을 기준으로 결정하기 때문에 채굴자는 항상 정확학 타임스탬프를 사용해야 한다.
    
    > 만약 마이너가 악의적으로 높은 타임스탬프 값을 사용한다면 난이도가 낮아지기 때문에 블록 생성 시 채택이 안 될 확률이 높아지고, 일부러 낮은 타임스탬프 값을 사용할 경우에는 난이도가 높아지기 때문에 마이닝 비용이 상승한다. 따라서 마이너는 항상 정확한 타임스탬프 를 사용해야 한다.
    > 
    
    ![스크린샷 2022-05-12 오전 11.33.55.png](10-10/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-12_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.33.55.png)
    
    - 뒤에서 나오는 난이도 폭탄은 실제 마이닝 시간을 강제로 늘리기 위한 가짜 블록 수를 계산해 낸다. 실제 마이닝 시간을 강제로 늘리는 것으로 작업 증명 방식의 마이닝을 줄이고 신규로 개발중인 지분 증명 방싱으로 전환하기 위해서다.

- 블록타임
    - 블록 타임은 블록이 생성되고 네트워크에 전파되는데 걸리는 시간을 말한다.
    - 이더리움에선 이 블록타임을 12초가 가장 적합하다고 판단하고 있으며, 최종적으로 12초의 블록 생성 시간을 만드는 것을 목표로 하고있다.
    



### 스마트 컨트랙트 (smart contract)

- 스마트 컨트랙트는 특정 계약을 스스로 수립 검증, 이행 하기위한 컴퓨터 프로토콜이다.
- 이더리움에서 스마트 컨트랙트는 이더리움 어카운트의 상태를 변경할 수 있는 프로그램 코드로서 이더리움 p2p 네트워크상에 배포되어 블록체인 내에 상태 정보로 존재하고, EVM에서 작동되어 상태 전이를 유발한다.

> 모든 트랜잭션을 실핼 할떄는 해당 실행 비용을 지급해야한다
→ 이더리움에서 이 비용은 가스로 지급한다
> 

> 컨트랙트의 모든 내용과 입력을 공유한다
→ 다만 여기서 공유하는 내용은 입력 정보만 공유하고, 결과는 공유하지 않는다, 블록체인의 컨트랙트와 트랜잭션, 리시트 정보를 재구성하면 언제든지 결과를 확인할 수 있기 때문이다.
> 

- 비트코인의 정적인 기록외에는 다른 어떠한 용도로 사용이 어려웠다
- 이더리움은 이러한 한계를 극복하기 위해 프로그램도 저장할 수 있도록 기능을 개선해 구현, 이를 스마트컨트랜트라 명했다.



### 이더리움과 디앱

- 스마트 컨트랙트
    - 블록체인의 범용화 라는 가능성을 실험해볼 수 있는 시작

- 이더리움
    - 디앱을 위한 플랫폼 역할
    - 수많은 디앱 개발자가 가치있고 다양한 프로그램을 제공해주기를 기대
    - [http://www.stateofthedapps.com](https://www.stateofthedapps.com/ko) (dapp 전사이트)
    
- 인증 기반의 블록체인 (디앱과 정보 노출의 딜레마)
    - 신원 확인과 허가를 통해 정보 보호의 문제를 해결하자는 아이디어
    - 인증을 담당한 서버, 신분을 확인 받고 허가 받은 구성원들과 스마트 컨트랙트만 사용하도록 통제
    - 하이퍼레저 패브릭 : 채널이라는 개념을 두고 정보는 동일 채널 내에서만 공유하도록 통제하는 방식
    
    - 인증을 담당하는 특정 서버가 존재하고 인증된 사람들로만 구성된 네트워크는 더 이상 탈중앙화 시스템이 아니다

- 하이브리드 시스템
    - 어떤 종류의 시스템을 조합해 문제를 해결하자는 아이디어
    - 아이디어 배경
        - 개인 정보 등의 민감한 정보를 다뤄야 하는 사안들은 기본적으로 모두 중앙화 등 정보 보호가 완벽히 되는 시스템을 활용
        - 그 결과만 블록체인에 저장해 기록의 비가역성을 통해 투명성을 높이자
        (투표시스템, 거래기록)



### 샤딩과 지분증명

- 샤딩(sharding), 샤드(shard)
- 근본적인 문제점
    - 탈중앙화된 시스템에서 구현하는 것이 불가능
    



## 하이퍼레저 패브릭

![스크린샷 2022-05-19 오전 11.31.30.png](10-10/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-19_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_11.31.30.png)



### 프라이빗 블록체인

- 하이퍼레저 : 대표적인 프라이빗 블록체인, 리눅스 재단의 오픈소스 블록체인 프로젝트
- 합의 방식과 구현 형태에 따라 5개의 독립적 프레임워크 프로젝트
    - 패브릭, 소우투스, 아이로하, 인디, 버로우
- 가장 활발하고 주목받는 프로젝트 : 하이퍼레저 패브릭
- 패브릭의 형태 : 통상 프라이빗 블록체인 또는 컨소시엄 블록체인이라 불림
    - MSP라 불리는 인증 관리 시스템에 등록된 사용자만 참여할 수 있음
    
- 하이버레저 기본 작동 원리
    - A그룹 (이용자)
        - 응용 프로그램을 통해 원하는 트랜잭션을 요청하는 역할
    - B그룹 (완전 노드가 하던 역할)
        - A그룹이 실행하려는 것을 감시하는 역할
    - C그룹 (블록체인에는 없는 역할)
        - 완전 노드의 역할 중 검증 후 동의에서 검증과 동의로 분리

- 패브릭 대 블록체인
    - 패드릭 동작과점 : 모든 응용 프로그램은 피어들로부터 보증서를 전달받아 결과의 무결성을 확인 받고 이 보증서를 정렬자에게 제출함으로써 최종확인을 거친 후 피어들의 원장을 갱신하는 과정

| 하이퍼레저 패브릭 | 블록체인 |
| --- | --- |
| 인증기반 | 익명기반 |
| 인증된 피어들에 따른 반복된 검증 | 원하는 모두에 따른 반복된 검증 |
| 정렬자가 항상 최종 기록을 허가 | 기록을 위한 리더를 랜덤 산출 |
| 정렬자에 의해 동기화 | 비동기화 시스템 |



### 변종 블록체인과 내부자 위협

- 탈중앙화의 작업증명이 사라지면 내부 누군가의 특권 악용으로 인해 위협이 발생할 수 있다.



### 탈중앙화

- 블록체인이 탄생한 배경부터 블록체인이 주목받았던 가장 큰 이유
    - 탈중앙화를 통해 독립적이고 자율적인 플랫폼을 구축할 수 있기를 기대
- 블록체인 네트워크 구조를 한 단어로 간명하게 표현해주는 단어
- 권력 기관의 간섭을 받지 않는 독립적이고 투명한 환경을 상징

→ 중개인이 없는 시스템, 블록체인은 직거래 방법중 하나에 불과